<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Anime Tracker</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar navbar-admin">
    <div class="container">
      <div class="nav-brand">
        <a href="/"><h1>üéå Anime Tracker</h1></a>
        <span class="admin-badge">ADMIN</span>
      </div>
      <div class="nav-links">
        <a href="/">Public Site</a>
        <a href="/admin" class="active">Dashboard</a>
        <div class="nav-user" id="navUser"></div>
      </div>
    </div>
  </nav>

  <main class="container admin-container">
    <!-- Admin Tabs -->
    <div class="admin-tabs">
      <button class="tab-btn active" data-tab="overview">üìä Overview</button>
      <button class="tab-btn" data-tab="dubs">üéôÔ∏è Dub Management</button>
      <button class="tab-btn" data-tab="sync">üîÑ Sync Jobs</button>
      <button class="tab-btn" data-tab="users">üë• Users</button>
    </div>

    <!-- Tab Content -->
    <div id="tabContent" class="admin-content">
      <div class="loading">Loading admin dashboard...</div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      let currentTab = 'overview';
      let dashboardData = null;
      let currentUser = null;

      // Auth check
      try {
        const authRes = await fetch('/auth/status');
        const authData = await authRes.json();
        if (!authData.authenticated) {
          window.location.href = '/';
          return;
        }
        currentUser = authData.user;
        
        // Check if admin
        const adminCheck = await fetch('/api/admin/dashboard');
        if (!adminCheck.ok) {
          alert('Access denied. Admin privileges required.');
          window.location.href = '/';
          return;
        }
        dashboardData = await adminCheck.json();

        document.getElementById('navUser').innerHTML = `
          <div class="user-menu">
            <img src="${currentUser.picture || ''}" alt="${currentUser.name}" class="user-avatar">
            <div class="user-dropdown">
              <a href="/dashboard">Dashboard</a>
              <a href="/auth/logout">Logout</a>
            </div>
          </div>
        `;

        renderTab();
      } catch (e) {
        console.error('Admin access error:', e);
        window.location.href = '/';
        return;
      }

      // Tab switching
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelector('.tab-btn.active').classList.remove('active');
          btn.classList.add('active');
          currentTab = btn.dataset.tab;
          renderTab();
        });
      });

      function renderTab() {
        const container = document.getElementById('tabContent');
        switch (currentTab) {
          case 'overview':
            renderOverview(container);
            break;
          case 'dubs':
            renderDubManagement(container);
            break;
          case 'sync':
            renderSyncJobs(container);
            break;
          case 'users':
            renderUsers(container);
            break;
        }
      }

      function renderOverview(container) {
        const stats = dashboardData.animeStats;
        const logs = dashboardData.syncLogs || [];
        const needsReview = dashboardData.needsDubReview || [];

        container.innerHTML = `
          <div class="admin-section">
            <h2>üìä Overview - ${stats.season} ${stats.year}</h2>
            
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-number">${stats.total || 0}</div>
                <div class="stat-label">Total Anime</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${stats.airing || 0}</div>
                <div class="stat-label">Currently Airing</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${stats.finished || 0}</div>
                <div class="stat-label">Finished</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${stats.with_dub || 0}</div>
                <div class="stat-label">With Dub</div>
              </div>
              <div class="stat-card">
                <div class="stat-number">${dashboardData.userCount || 0}</div>
                <div class="stat-label">Registered Users</div>
              </div>
            </div>
          </div>

          <div class="admin-section">
            <h2>üîÑ Recent Sync Jobs</h2>
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Added</th>
                  <th>Updated</th>
                  <th>Started</th>
                </tr>
              </thead>
              <tbody>
                ${logs.map(log => `
                  <tr>
                    <td>${log.job_type}</td>
                    <td class="status-${log.status.toLowerCase()}">${log.status}</td>
                    <td>${log.anime_added}</td>
                    <td>${log.anime_updated}</td>
                    <td>${new Date(log.started_at).toLocaleString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>

          <div class="admin-section">
            <h2>‚ö†Ô∏è Needs Dub Review (${needsReview.length})</h2>
            <p class="section-desc">Popular anime without dub information</p>
            <div class="review-grid">
              ${needsReview.slice(0, 10).map(a => `
                <div class="review-card">
                  <img src="${a.poster_url || ''}" alt="${a.title}">
                  <div class="review-info">
                    <span class="review-title">${a.title}</span>
                    <span class="review-pop">Pop: ${a.popularity}</span>
                    <button class="btn-small btn-add-dub" data-id="${a.id}" data-title="${a.title}">Add Dub</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;

        // Add dub buttons
        document.querySelectorAll('.btn-add-dub').forEach(btn => {
          btn.addEventListener('click', () => {
            currentTab = 'dubs';
            document.querySelector('.tab-btn.active').classList.remove('active');
            document.querySelector('[data-tab="dubs"]').classList.add('active');
            renderDubManagement(container, btn.dataset.id);
          });
        });
      }

      function renderDubManagement(container, preselectedId = null) {
        container.innerHTML = `
          <div class="admin-section">
            <h2>üéôÔ∏è Dub Management</h2>
            
            <div class="dub-form">
              <h3>${preselectedId ? 'Add Dub Info' : 'Search & Add Dub'}</h3>
              
              <div class="form-row">
                <input type="text" id="animeSearch" placeholder="Search anime..." class="form-input">
                <button id="searchBtn" class="btn-primary">Search</button>
              </div>
              
              <div id="searchResults" class="search-results"></div>
              
              <div id="dubForm" class="dub-edit-form" style="display: none;">
                <h4>Edit Dub Info for: <span id="selectedAnimeTitle"></span></h4>
                <input type="hidden" id="selectedAnimeId">
                
                <div class="form-row">
                  <select id="dubPlatform" class="form-input">
                    <option value="Crunchyroll">Crunchyroll</option>
                    <option value="HIDIVE">HIDIVE</option>
                    <option value="Netflix">Netflix</option>
                    <option value="Amazon">Amazon Prime</option>
                    <option value="Hulu">Hulu</option>
                    <option value="Disney+">Disney+</option>
                    <option value="Funimation">Funimation</option>
                    <option value="Other">Other</option>
                  </select>
                  
                  <select id="dubStatus" class="form-input">
                    <option value="NONE">No Dub</option>
                    <option value="ONGOING">Ongoing</option>
                    <option value="FINISHED">Finished</option>
                    <option value="ANNOUNCED">Announced</option>
                  </select>
                </div>
                
                <div class="form-row">
                  <label>Episodes Dubbed:</label>
                  <input type="number" id="dubEpisodes" class="form-input" min="0">
                </div>
                
                <div class="form-row">
                  <label>Start Date:</label>
                  <input type="date" id="dubStartDate" class="form-input">
                  
                  <label>End Date:</label>
                  <input type="date" id="dubEndDate" class="form-input">
                </div>
                
                <div class="form-row">
                  <label>Notes:</label>
                  <textarea id="dubNotes" class="form-input" rows="2"></textarea>
                </div>
                
                <div class="form-actions">
                  <button id="saveDubBtn" class="btn-primary">Save Dub Info</button>
                  <button id="cancelDubBtn" class="btn-secondary">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <div class="admin-section">
            <h2>Recent Dubs</h2>
            <div id="recentDubs" class="loading">Loading...</div>
          </div>
        `;

        // Search functionality
        document.getElementById('searchBtn').addEventListener('click', async () => {
          const query = document.getElementById('animeSearch').value;
          if (!query) return;
          
          const resultsContainer = document.getElementById('searchResults');
          resultsContainer.innerHTML = '<div class="loading">Searching...</div>';
          
          try {
            const res = await fetch(`/api/admin/anime/search?q=${encodeURIComponent(query)}&limit=10`);
            const results = await res.json();
            
            if (results.length === 0) {
              resultsContainer.innerHTML = '<p>No results found</p>';
              return;
            }
            
            resultsContainer.innerHTML = results.map(a => `
              <div class="search-result" data-id="${a.id}">
                <img src="${a.poster_url || ''}" alt="${a.title}">
                <div class="result-info">
                  <span class="result-title">${a.title_english || a.title}</span>
                  <span class="result-meta">${a.season} ${a.year} ‚Ä¢ ${a.status}</span>
                </div>
                <button class="btn-small btn-select" data-id="${a.id}" data-title="${a.title_english || a.title}">Select</button>
              </div>
            `).join('');
            
            // Select buttons
            document.querySelectorAll('.btn-select').forEach(btn => {
              btn.addEventListener('click', () => selectAnimeForDub(btn.dataset.id, btn.dataset.title));
            });
          } catch (e) {
            resultsContainer.innerHTML = '<p class="error">Search failed</p>';
          }
        });

        function selectAnimeForDub(id, title) {
          document.getElementById('dubForm').style.display = 'block';
          document.getElementById('selectedAnimeId').value = id;
          document.getElementById('selectedAnimeTitle').textContent = title;
        }

        // Save dub
        document.getElementById('saveDubBtn').addEventListener('click', async () => {
          const data = {
            anime_id: document.getElementById('selectedAnimeId').value,
            platform: document.getElementById('dubPlatform').value,
            dub_status: document.getElementById('dubStatus').value,
            episodes_dubbed: document.getElementById('dubEpisodes').value || 0,
            dub_start_date: document.getElementById('dubStartDate').value || null,
            dub_end_date: document.getElementById('dubEndDate').value || null,
            notes: document.getElementById('dubNotes').value || null
          };
          
          try {
            const res = await fetch('/api/admin/dubs', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            
            if (res.ok) {
              alert('Dub info saved!');
              document.getElementById('dubForm').style.display = 'none';
              loadRecentDubs();
            } else {
              alert('Error saving dub info');
            }
          } catch (e) {
            alert('Error saving dub info');
          }
        });

        document.getElementById('cancelDubBtn').addEventListener('click', () => {
          document.getElementById('dubForm').style.display = 'none';
        });

        loadRecentDubs();
        
        // If preselected
        if (preselectedId) {
          const anime = dashboardData.needsDubReview.find(a => a.id == preselectedId);
          if (anime) selectAnimeForDub(preselectedId, anime.title);
        }
      }

      async function loadRecentDubs() {
        const container = document.getElementById('recentDubs');
        try {
          const res = await fetch('/api/admin/dubs?limit=20');
          const dubs = await res.json();
          
          if (dubs.length === 0) {
            container.innerHTML = '<p>No dubs added yet</p>';
            return;
          }
          
          container.innerHTML = `
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Anime</th>
                  <th>Platform</th>
                  <th>Status</th>
                  <th>Episodes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${dubs.map(d => `
                  <tr>
                    <td>${d.title_english || d.title}</td>
                    <td>${d.platform}</td>
                    <td>${d.dub_status}</td>
                    <td>${d.episodes_dubbed || 0}</td>
                    <td>
                      <button class="btn-small btn-delete-dub" data-id="${d.id}">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          
          // Delete buttons
          document.querySelectorAll('.btn-delete-dub').forEach(btn => {
            btn.addEventListener('click', async () => {
              if (!confirm('Delete this dub entry?')) return;
              await fetch(`/api/admin/dubs/${btn.dataset.id}`, { method: 'DELETE' });
              loadRecentDubs();
            });
          });
        } catch (e) {
          container.innerHTML = '<p class="error">Error loading dubs</p>';
        }
      }

      function renderSyncJobs(container) {
        container.innerHTML = `
          <div class="admin-section">
            <h2>üîÑ Manual Sync Jobs</h2>
            <p class="section-desc">Trigger sync jobs manually. These normally run automatically.</p>
            
            <div class="sync-buttons">
              <div class="sync-card">
                <h3>üå± Season Sync</h3>
                <p>Fetches all anime for current season from AniList</p>
                <p><small>Auto-runs: Start of each season + weekly</small></p>
                <button id="triggerSeasonSync" class="btn-primary">Run Season Sync</button>
              </div>
              
              <div class="sync-card">
                <h3>üìÜ Daily Update</h3>
                <p>Updates episode counts and status for airing anime</p>
                <p><small>Auto-runs: Daily at 2 AM</small></p>
                <button id="triggerDailyUpdate" class="btn-primary">Run Daily Update</button>
              </div>
            </div>
          </div>
          
          <div class="admin-section">
            <h2>Sync History</h2>
            <div id="syncLogs" class="loading">Loading...</div>
          </div>
        `;

        document.getElementById('triggerSeasonSync').addEventListener('click', async () => {
          if (!confirm('Start season sync? This may take several minutes.')) return;
          await fetch('/api/admin/sync/season', { method: 'POST' });
          alert('Season sync started in background. Check logs for progress.');
        });

        document.getElementById('triggerDailyUpdate').addEventListener('click', async () => {
          if (!confirm('Start daily update?')) return;
          await fetch('/api/admin/sync/daily', { method: 'POST' });
          alert('Daily update started in background.');
        });

        loadSyncLogs();
      }

      async function loadSyncLogs() {
        const container = document.getElementById('syncLogs');
        try {
          const res = await fetch('/api/admin/sync/logs?limit=20');
          const logs = await res.json();
          
          container.innerHTML = `
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Added</th>
                  <th>Updated</th>
                  <th>Started</th>
                  <th>Completed</th>
                </tr>
              </thead>
              <tbody>
                ${logs.map(log => `
                  <tr>
                    <td>${log.job_type}</td>
                    <td class="status-${log.status.toLowerCase()}">${log.status}</td>
                    <td>${log.anime_added}</td>
                    <td>${log.anime_updated}</td>
                    <td>${new Date(log.started_at).toLocaleString()}</td>
                    <td>${log.completed_at ? new Date(log.completed_at).toLocaleString() : 'Running...'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } catch (e) {
          container.innerHTML = '<p class="error">Error loading logs</p>';
        }
      }

      function renderUsers(container) {
        container.innerHTML = `
          <div class="admin-section">
            <h2>üë• User Management</h2>
            <div id="userList" class="loading">Loading users...</div>
          </div>
        `;

        loadUsers();
      }

      async function loadUsers() {
        const container = document.getElementById('userList');
        try {
          const res = await fetch('/api/admin/users');
          const users = await res.json();
          
          container.innerHTML = `
            <table class="admin-table">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Email</th>
                  <th>Anime Count</th>
                  <th>Joined</th>
                  <th>Admin</th>
                </tr>
              </thead>
              <tbody>
                ${users.map(u => `
                  <tr>
                    <td>
                      <div class="user-cell">
                        <img src="${u.picture || ''}" alt="${u.name}" class="user-avatar-small">
                        ${u.name}
                      </div>
                    </td>
                    <td>${u.email || '-'}</td>
                    <td>${u.anime_count}</td>
                    <td>${new Date(u.created_at).toLocaleDateString()}</td>
                    <td>
                      <input type="checkbox" class="admin-toggle" data-id="${u.id}" ${u.is_admin ? 'checked' : ''}>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          
          // Admin toggles
          document.querySelectorAll('.admin-toggle').forEach(toggle => {
            toggle.addEventListener('change', async (e) => {
              await fetch(`/api/admin/users/${e.target.dataset.id}/admin`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ isAdmin: e.target.checked })
              });
            });
          });
        } catch (e) {
          container.innerHTML = '<p class="error">Error loading users</p>';
        }
      }
    });
  </script>
</body>
</html>
