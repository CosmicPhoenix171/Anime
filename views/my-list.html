<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Anime List - Anime Tracker</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <a href="/"><h1>üéå Anime Tracker</h1></a>
      </div>
      <div class="nav-links">
        <a href="/">Current Season</a>
        <a href="/recently-finished">Recently Finished</a>
        <a href="/dub-radar">Dub Radar</a>
        <div class="nav-user" id="navUser"></div>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="page-header">
      <h1>üìã My Anime List</h1>
      <p id="userGreeting"></p>
    </div>

    <!-- Tabs -->
    <div class="list-tabs">
      <button class="tab-btn active" data-status="WATCHING">
        <span class="tab-icon">üì∫</span> Watching <span class="tab-count" id="countWatching">0</span>
      </button>
      <button class="tab-btn" data-status="PLANNED">
        <span class="tab-icon">üìù</span> Planned <span class="tab-count" id="countPlanned">0</span>
      </button>
      <button class="tab-btn" data-status="FINISHED">
        <span class="tab-icon">‚úÖ</span> Finished <span class="tab-count" id="countFinished">0</span>
      </button>
      <button class="tab-btn" data-status="DROPPED">
        <span class="tab-icon">üö´</span> Dropped <span class="tab-count" id="countDropped">0</span>
      </button>
      <button class="tab-btn" data-status="ON_HOLD">
        <span class="tab-icon">‚è∏Ô∏è</span> On Hold <span class="tab-count" id="countOnHold">0</span>
      </button>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
      <select id="sortFilter">
        <option value="updated">Recently Updated</option>
        <option value="title">Alphabetical</option>
        <option value="behind">Most Behind</option>
        <option value="progress">Progress</option>
      </select>
      <label class="checkbox-label">
        <input type="checkbox" id="dubOnlyFilter"> Dub Only
      </label>
    </div>

    <!-- Anime List -->
    <section id="animeList" class="anime-list">
      <div class="loading">Loading your list...</div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2026 Anime Tracker. Powered by AniList API</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      let allProgress = [];
      let currentStatus = 'WATCHING';
      let currentUser = null;

      const listContainer = document.getElementById('animeList');
      const sortFilter = document.getElementById('sortFilter');
      const dubOnlyFilter = document.getElementById('dubOnlyFilter');

      // Auth check
      try {
        const authRes = await fetch('/auth/status');
        const authData = await authRes.json();
        if (!authData.authenticated) {
          window.location.href = '/';
          return;
        }
        currentUser = authData.user;
        document.getElementById('userGreeting').textContent = `Welcome back, ${currentUser.name}!`;
        document.getElementById('navUser').innerHTML = `
          <div class="user-menu">
            <img src="${currentUser.picture || ''}" alt="${currentUser.name}" class="user-avatar">
            <div class="user-dropdown">
              <a href="/dashboard">Dashboard</a>
              <a href="/my-list" class="active">My List</a>
              <a href="/my-season">My Season</a>
              <a href="/auth/logout">Logout</a>
            </div>
          </div>
        `;
      } catch (e) {
        window.location.href = '/';
        return;
      }

      await loadProgress();

      async function loadProgress() {
        try {
          const response = await fetch('/api/user/progress');
          allProgress = await response.json();
          updateCounts();
          renderList();
        } catch (error) {
          listContainer.innerHTML = '<div class="error">Error loading your list</div>';
        }
      }

      function updateCounts() {
        const counts = {
          WATCHING: 0, PLANNED: 0, FINISHED: 0, DROPPED: 0, ON_HOLD: 0
        };
        allProgress.forEach(p => {
          if (counts[p.user_status] !== undefined) counts[p.user_status]++;
        });
        
        document.getElementById('countWatching').textContent = counts.WATCHING;
        document.getElementById('countPlanned').textContent = counts.PLANNED;
        document.getElementById('countFinished').textContent = counts.FINISHED;
        document.getElementById('countDropped').textContent = counts.DROPPED;
        document.getElementById('countOnHold').textContent = counts.ON_HOLD;
      }

      function renderList() {
        let filtered = allProgress.filter(p => p.user_status === currentStatus);
        
        // Dub filter
        if (dubOnlyFilter.checked) {
          filtered = filtered.filter(p => p.dub_info && p.dub_info.includes('ONGOING') || p.dub_info?.includes('FINISHED'));
        }

        // Sort
        const sort = sortFilter.value;
        filtered.sort((a, b) => {
          switch (sort) {
            case 'updated':
              return new Date(b.updated_at) - new Date(a.updated_at);
            case 'title':
              return (a.title || '').localeCompare(b.title || '');
            case 'behind':
              return (b.episodes_behind || 0) - (a.episodes_behind || 0);
            case 'progress':
              const progA = a.last_episode / (a.total_episodes || 1);
              const progB = b.last_episode / (b.total_episodes || 1);
              return progB - progA;
          }
          return 0;
        });

        if (filtered.length === 0) {
          listContainer.innerHTML = `<div class="empty-state">No anime in this category</div>`;
          return;
        }

        listContainer.innerHTML = filtered.map(createListItem).join('');
        attachEventListeners();
      }

      function createListItem(item) {
        const title = item.title_english || item.title;
        const imageUrl = item.poster_url || 'https://via.placeholder.com/60x90?text=?';
        const totalEps = item.total_episodes || '?';
        const airedEps = item.episodes_aired || 0;
        const watchedEps = item.last_episode || 0;
        const behind = item.episodes_behind || 0;

        // Progress percentage
        const progressPct = totalEps !== '?' ? Math.round((watchedEps / totalEps) * 100) : 0;

        // Status badge for anime
        let animeStatusBadge = '';
        if (item.anime_status === 'AIRING') {
          animeStatusBadge = '<span class="anime-badge badge-airing">Airing</span>';
        } else if (item.anime_status === 'FINISHED') {
          animeStatusBadge = '<span class="anime-badge badge-finished">Finished</span>';
        }

        // Dub info
        let dubBadge = '';
        if (item.dub_info) {
          if (item.dub_info.includes('FINISHED')) {
            dubBadge = '<span class="anime-badge badge-dub-complete">DUB ‚úì</span>';
          } else if (item.dub_info.includes('ONGOING')) {
            dubBadge = '<span class="anime-badge badge-dub">DUB</span>';
          }
        }

        return `
          <div class="list-item" data-id="${item.anime_id}">
            <a href="/anime/${item.anime_id}" class="list-item-poster">
              <img src="${imageUrl}" alt="${title}" loading="lazy">
            </a>
            <div class="list-item-info">
              <a href="/anime/${item.anime_id}" class="list-item-title">${title}</a>
              <div class="list-item-meta">
                ${animeStatusBadge}
                ${dubBadge}
                <span class="meta-text">${item.season} ${item.year}</span>
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${progressPct}%"></div>
              </div>
              <div class="list-item-progress">
                <span>EP ${watchedEps} / ${totalEps}</span>
                ${behind > 0 ? `<span class="behind-text">(${behind} behind)</span>` : ''}
              </div>
            </div>
            <div class="list-item-actions">
              <button class="btn-icon btn-increment" title="+1 Episode">+1</button>
              <button class="btn-icon btn-finish" title="Mark Finished">‚úì</button>
              <select class="status-select" data-id="${item.anime_id}">
                <option value="WATCHING" ${item.user_status === 'WATCHING' ? 'selected' : ''}>Watching</option>
                <option value="PLANNED" ${item.user_status === 'PLANNED' ? 'selected' : ''}>Planned</option>
                <option value="FINISHED" ${item.user_status === 'FINISHED' ? 'selected' : ''}>Finished</option>
                <option value="DROPPED" ${item.user_status === 'DROPPED' ? 'selected' : ''}>Dropped</option>
                <option value="ON_HOLD" ${item.user_status === 'ON_HOLD' ? 'selected' : ''}>On Hold</option>
              </select>
              <button class="btn-icon btn-remove" title="Remove from list">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }

      function attachEventListeners() {
        // Increment buttons
        document.querySelectorAll('.btn-increment').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.closest('.list-item').dataset.id;
            await fetch(`/api/user/progress/${id}/increment`, { method: 'POST' });
            await loadProgress();
          });
        });

        // Finish buttons
        document.querySelectorAll('.btn-finish').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.closest('.list-item').dataset.id;
            await fetch(`/api/user/progress/${id}/finish`, { method: 'POST' });
            await loadProgress();
          });
        });

        // Status selects
        document.querySelectorAll('.status-select').forEach(select => {
          select.addEventListener('change', async (e) => {
            const id = e.target.dataset.id;
            await fetch(`/api/user/progress/${id}/status`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status: e.target.value })
            });
            await loadProgress();
          });
        });

        // Remove buttons
        document.querySelectorAll('.btn-remove').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            if (!confirm('Remove this anime from your list?')) return;
            const id = e.target.closest('.list-item').dataset.id;
            await fetch(`/api/user/progress/${id}`, { method: 'DELETE' });
            await loadProgress();
          });
        });
      }

      // Tab switching
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelector('.tab-btn.active').classList.remove('active');
          btn.classList.add('active');
          currentStatus = btn.dataset.status;
          renderList();
        });
      });

      // Filter changes
      sortFilter.addEventListener('change', renderList);
      dubOnlyFilter.addEventListener('change', renderList);
    });
  </script>
</body>
</html>
