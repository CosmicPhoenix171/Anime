<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recently Finished - Anime Tracker</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <a href="/"><h1>üéå Anime Tracker</h1></a>
      </div>
      <div class="nav-links">
        <a href="/">Current Season</a>
        <a href="/recently-finished" class="active">Recently Finished</a>
        <a href="/dub-radar">Dub Radar</a>
        <div class="nav-user" id="navUser">
          <button id="loginBtn" class="btn-primary">Login with Google</button>
        </div>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="page-header">
      <h1>üèÅ Recently Finished</h1>
      <p>Anime that wrapped up recently - time to binge!</p>
    </div>

    <!-- Time Filter -->
    <div class="filter-bar">
      <select id="timeFilter">
        <option value="7">Last 7 Days</option>
        <option value="30" selected>Last 30 Days</option>
        <option value="90">Last 3 Months</option>
      </select>
    </div>

    <!-- Finished Anime Grid -->
    <section id="finishedGrid" class="anime-grid">
      <div class="loading">Loading finished anime...</div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2026 Anime Tracker. Powered by AniList API</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const grid = document.getElementById('finishedGrid');
      const timeFilter = document.getElementById('timeFilter');
      let currentUser = null;

      // Auth check
      try {
        const authRes = await fetch('/auth/status');
        const authData = await authRes.json();
        if (authData.authenticated) {
          currentUser = authData.user;
          const navUser = document.getElementById('navUser');
          navUser.innerHTML = `
            <div class="user-menu">
              <img src="${currentUser.picture || ''}" alt="${currentUser.name}" class="user-avatar">
              <div class="user-dropdown">
                <a href="/dashboard">Dashboard</a>
                <a href="/my-list">My List</a>
                <a href="/auth/logout">Logout</a>
              </div>
            </div>
          `;
        }
      } catch (e) {}

      async function loadFinished() {
        grid.innerHTML = '<div class="loading">Loading...</div>';
        const days = timeFilter.value;

        try {
          const response = await fetch(`/api/anime/recently-finished?days=${days}`);
          const anime = await response.json();

          if (anime.length === 0) {
            grid.innerHTML = '<div class="no-data">No anime finished in this time period</div>';
            return;
          }

          // Group by week
          const now = new Date();
          const thisWeek = [];
          const thisMonth = [];
          const older = [];

          anime.forEach(a => {
            if (!a.end_date) {
              older.push(a);
              return;
            }
            const endDate = new Date(a.end_date);
            const diffDays = Math.floor((now - endDate) / (1000 * 60 * 60 * 24));
            
            if (diffDays <= 7) thisWeek.push(a);
            else if (diffDays <= 30) thisMonth.push(a);
            else older.push(a);
          });

          let html = '';

          if (thisWeek.length > 0) {
            html += `
              <div class="section-group">
                <h2 class="section-title">Finished This Week</h2>
                <div class="anime-grid">${thisWeek.map(createCard).join('')}</div>
              </div>
            `;
          }

          if (thisMonth.length > 0) {
            html += `
              <div class="section-group">
                <h2 class="section-title">Finished This Month</h2>
                <div class="anime-grid">${thisMonth.map(createCard).join('')}</div>
              </div>
            `;
          }

          if (older.length > 0) {
            html += `
              <div class="section-group">
                <h2 class="section-title">Finished Earlier</h2>
                <div class="anime-grid">${older.map(createCard).join('')}</div>
              </div>
            `;
          }

          grid.innerHTML = html || '<div class="no-data">No finished anime found</div>';

        } catch (error) {
          grid.innerHTML = '<div class="error">Error loading anime</div>';
        }
      }

      function createCard(anime) {
        const title = anime.title_english || anime.title;
        const imageUrl = anime.poster_url || 'https://via.placeholder.com/200x280?text=No+Image';

        // Dub badge
        let dubBadge = '';
        if (anime.dub_info) {
          const dubs = anime.dub_info.split(',');
          for (const dub of dubs) {
            const [platform, status] = dub.split(':');
            if (status === 'FINISHED') {
              dubBadge = `<span class="anime-badge badge-dub-complete">DUB ‚úì</span>`;
              break;
            } else if (status === 'ONGOING') {
              dubBadge = `<span class="anime-badge badge-dub">DUB</span>`;
            }
          }
        }

        return `
          <a href="/anime/${anime.id}" class="anime-card">
            <div class="anime-card-image">
              <img src="${imageUrl}" alt="${title}" loading="lazy">
              ${anime.average_score ? `<span class="anime-score">${anime.average_score}%</span>` : ''}
            </div>
            <div class="anime-card-body">
              <div class="anime-card-title">${title}</div>
              <div class="anime-card-info">
                <span>${anime.total_episodes || '?'} episodes</span>
                ${anime.end_date ? `<span>Ended ${anime.end_date}</span>` : ''}
              </div>
              <div class="anime-card-badges">
                <span class="anime-badge badge-finished">Finished</span>
                ${dubBadge}
              </div>
            </div>
          </a>
        `;
      }

      timeFilter.addEventListener('change', loadFinished);
      loadFinished();
    });
  </script>
</body>
</html>
